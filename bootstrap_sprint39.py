"""
MABE Sprint 39 Overlay: Modality-Branched Parameter Routing

Fix: Host-guest regression from Stage 2 shared-param optimization.
Solution: Separate PhysicsParameters per modality (Option A).
  Host-guest -> S37a params (MAE=1.33, R2=0.48)
  Protein-ligand -> S38 params + offsets (MAE=1.05)
  Metal -> S38 params (MAE=15.11, frozen)

Prereqs: bootstrap_sprint37.py + bootstrap_sprint38.py already applied.
"""
import base64, pathlib

FILES = {
    "core/modality_params.py": "IiIiCmNvcmUvbW9kYWxpdHlfcGFyYW1zLnB5IC0tIFNwcmludCAzOTogTW9kYWxpdHktQnJhbmNoZWQgUGFyYW1ldGVyIFJvdXRpbmcKClByb2JsZW06IFN0YWdlIDIgKFNwcmludCAzOCkgb3B0aW1pemVkIHNoYXJlZCBwYXJhbXMgYWdhaW5zdCAyMWsgcHJvdGVpbi1saWdhbmQKZW50cmllcywgbW92aW5nIG5ldXRyYWwgSC1ib25kLCBzaGFwZSwgY2F0aW9uLXBpLCByb3RvciBlbnRyb3B5IGF3YXkgZnJvbQpob3N0LWd1ZXN0IG9wdGltYWwgdmFsdWVzLgoKICAgIFMzNyBwYXJhbXMgLT4gSEcgTUFFPTEuMzMsIFIyPTAuNDgKICAgIFMzOCBwYXJhbXMgLT4gSEcgTUFFPTEuODksIFIyPS0wLjA0ICAocmVncmVzc2VkKQogICAgUzM4IHBhcmFtcyAtPiBQTCBNQUU9MS4wIChtYWludGFpbmVkIHdpdGggb2Zmc2V0cykKCkZpeDogU2VwYXJhdGUgUGh5c2ljc1BhcmFtZXRlcnMgcGVyIG1vZGFsaXR5LiBUaGUgcHJlZGljdG9yIHJvdXRlcyBiYXNlZCBvbgpiaW5kaW5nX21vZGUuIEVhY2ggbW9kYWxpdHkga2VlcHMgaXRzIG93biBjYWxpYnJhdGVkIHZhbHVlcyBmb3IgdGhlIHVuaXZlcnNhbAp0ZXJtcyB0aGF0IGRpdmVyZ2VkLgoKTWV0YWwgY29vcmRpbmF0aW9uIHBhcmFtcyBhcmUgaWRlbnRpY2FsIGluIGJvdGggKGZyb3plbiBmcm9tIFNwcmludCAzN2EpLgpUaGUgNiBwYXJhbXMgdGhhdCBtb3ZlZCA+MzAlIGFsbCBsaXZlIGluIHRoZSB1bml2ZXJzYWwgdGVybXMgKFBoYXNlcyA2LTEwKS4KIiIiCgpmcm9tIGNvcmUudW5pdmVyc2FsX3ByZWRpY3RvciBpbXBvcnQgUGh5c2ljc1BhcmFtZXRlcnMsIHByZWRpY3QsIFByZWRpY3Rpb25SZXN1bHQKZnJvbSBjb3JlLmNhbGlicmF0ZWRfcGFyYW1zIGltcG9ydCBnZXRfY2FsaWJyYXRlZF9wYXJhbXMgYXMgX2dldF9zMzdfcGFyYW1zCmZyb20gY29yZS5jYWxpYnJhdGVkX3NwcmludDM4X2ZpbmFsIGltcG9ydCAoCiAgICBnZXRfY2FsaWJyYXRlZF9wYXJhbXMgYXMgX2dldF9zMzhfcGFyYW1zLAogICAgVEFSR0VUX09GRlNFVFMsCikKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBIT1NULUdVRVNUIFBBUkFNUzogU3ByaW50IDM3YSBjYWxpYnJhdGlvbiAoNDEgSEcgZW50cmllcywgMjAgZnJlZSkKIyBNQUU9MS4zMywgUjI9MC40OCBvbiBlbnJpY2hlZCBob3N0LWd1ZXN0CiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKZGVmIGdldF9ob3N0X2d1ZXN0X3BhcmFtcygpOgogICAgIiIiUzM3YS1jYWxpYnJhdGVkIHBhcmFtcyBvcHRpbWFsIGZvciBob3N0LWd1ZXN0IGluY2x1c2lvbi4iIiIKICAgIHJldHVybiBfZ2V0X3MzN19wYXJhbXMoKQoKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFBST1RFSU4tTElHQU5EIFBBUkFNUzogU3ByaW50IDM4IFN0YWdlIDIgKDIxayBlbnRyaWVzLCAxOCBmcmVlKQojIE1BRT0xLjAgd2l0aCBwZXItdGFyZ2V0IG9mZnNldHMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpkZWYgZ2V0X3Byb3RlaW5fbGlnYW5kX3BhcmFtcygpOgogICAgIiIiUzM4LWNhbGlicmF0ZWQgcGFyYW1zIG9wdGltYWwgZm9yIHByb3RlaW4tbGlnYW5kLiIiIgogICAgcmV0dXJuIF9nZXRfczM4X3BhcmFtcygpCgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgTUVUQUwgQ09PUkRJTkFUSU9OIFBBUkFNUzogU2FtZSBpbiBib3RoIChmcm96ZW4sIG5lZWRzIE5JU1QgZXhwYW5zaW9uKQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCmRlZiBnZXRfbWV0YWxfcGFyYW1zKCk6CiAgICAiIiJNZXRhbCBwYXJhbXMgYXJlIGlkZW50aWNhbCBpbiBTMzcgYW5kIFMzOC4gVXNlIFMzOCAoaGFzIGFsbCBmaWVsZHMgc2V0KS4iIiIKICAgIHJldHVybiBfZ2V0X3MzOF9wYXJhbXMoKQoKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFJPVVRJTkcKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpfTU9EQUxJVFlfTUFQID0gewogICAgImhvc3RfZ3Vlc3RfaW5jbHVzaW9uIjogZ2V0X2hvc3RfZ3Vlc3RfcGFyYW1zLAogICAgInN5bnRoZXRpY19yZWNlcHRvciI6IGdldF9ob3N0X2d1ZXN0X3BhcmFtcywKICAgICJtZXRhbF9jb29yZGluYXRpb24iOiBnZXRfbWV0YWxfcGFyYW1zLAogICAgInByb3RlaW5fbGlnYW5kIjogZ2V0X3Byb3RlaW5fbGlnYW5kX3BhcmFtcywKfQoKCmRlZiBnZXRfcGFyYW1zX2Zvcl9tb2RhbGl0eShiaW5kaW5nX21vZGUpOgogICAgIiIiUmV0dXJuIHRoZSBvcHRpbWFsIFBoeXNpY3NQYXJhbWV0ZXJzIGZvciBhIGdpdmVuIGJpbmRpbmcgbW9kZS4KCiAgICBGYWxscyBiYWNrIHRvIFMzOCBwYXJhbXMgZm9yIHVua25vd24gbW9kYWxpdGllcy4KICAgICIiIgogICAgZ2V0dGVyID0gX01PREFMSVRZX01BUC5nZXQoYmluZGluZ19tb2RlLCBnZXRfcHJvdGVpbl9saWdhbmRfcGFyYW1zKQogICAgcmV0dXJuIGdldHRlcigpCgoKZGVmIHByZWRpY3Rfcm91dGVkKHVjLCBwYXJhbXNfb3ZlcnJpZGU9Tm9uZSk6CiAgICAiIiJQcmVkaWN0IHdpdGggYXV0b21hdGljIG1vZGFsaXR5LWJhc2VkIHBhcmFtZXRlciByb3V0aW5nLgoKICAgIElmIHBhcmFtc19vdmVycmlkZSBpcyBwcm92aWRlZCwgdXNlcyB0aGF0IGRpcmVjdGx5IChmb3IgYmFja3NvbHZlKS4KICAgIE90aGVyd2lzZSByb3V0ZXMgdG8gdGhlIG9wdGltYWwgcGFyYW0gc2V0IGZvciB0aGlzIGJpbmRpbmdfbW9kZS4KCiAgICBGb3IgcHJvdGVpbi1saWdhbmQsIGFwcGxpZXMgcGVyLXRhcmdldCBvZmZzZXRzLgogICAgIiIiCiAgICBpZiBwYXJhbXNfb3ZlcnJpZGUgaXMgbm90IE5vbmU6CiAgICAgICAgcGFyYW1zID0gcGFyYW1zX292ZXJyaWRlCiAgICBlbHNlOgogICAgICAgIHBhcmFtcyA9IGdldF9wYXJhbXNfZm9yX21vZGFsaXR5KHVjLmJpbmRpbmdfbW9kZSkKCiAgICByZXN1bHQgPSBwcmVkaWN0KHVjLCBwYXJhbXMpCgogICAgIyBBcHBseSBwZXItdGFyZ2V0IG9mZnNldCBmb3IgcHJvdGVpbi1saWdhbmQKICAgIGlmIHVjLmJpbmRpbmdfbW9kZSA9PSAicHJvdGVpbl9saWdhbmQiOgogICAgICAgIG9mZnNldCA9IFRBUkdFVF9PRkZTRVRTLmdldCh1Yy5ob3N0X25hbWUsIDAuMCkKICAgICAgICByZXN1bHQubG9nX0thX3ByZWQgKz0gb2Zmc2V0CiAgICAgICAgcmVzdWx0LmVycm9yID0gcmVzdWx0LmxvZ19LYV9wcmVkIC0gcmVzdWx0LmxvZ19LYV9leHAKICAgICAgICByZXN1bHQuZGdfcHJlZF9raiA9IC1yZXN1bHQubG9nX0thX3ByZWQgKiA1LjcxCgogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBwcmVkaWN0X3JvdXRlZF9iYXRjaChlbnRyaWVzLCBwYXJhbXNfb3ZlcnJpZGU9Tm9uZSk6CiAgICAiIiJCYXRjaCBwcmVkaWN0IHdpdGggcm91dGluZy4iIiIKICAgIHJlc3VsdHMgPSBbXQogICAgZm9yIHVjIGluIGVudHJpZXM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByID0gcHJlZGljdF9yb3V0ZWQodWMsIHBhcmFtc19vdmVycmlkZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHIgPSBQcmVkaWN0aW9uUmVzdWx0KAogICAgICAgICAgICAgICAgbmFtZT11Yy5uYW1lLCBiaW5kaW5nX21vZGU9dWMuYmluZGluZ19tb2RlLAogICAgICAgICAgICAgICAgbG9nX0thX2V4cD11Yy5sb2dfS2FfZXhwLCBsb2dfS2FfcHJlZD0wLjAsCiAgICAgICAgICAgICAgICBkZ19wcmVkX2tqPTAuMCwgZXJyb3I9LXVjLmxvZ19LYV9leHApCiAgICAgICAgcmVzdWx0cy5hcHBlbmQocikKICAgIHJldHVybiByZXN1bHRzCg==",
}

for path, b64 in FILES.items():
    pathlib.Path(path).parent.mkdir(parents=True, exist_ok=True)
    content = base64.b64decode(b64).decode("ascii")
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"  Created: {path}")

print()
print("Sprint 39 overlay applied: Modality-branched parameter routing.")
print("  Host-guest:      S37a params (MAE=1.33, R2=0.48)")
print("  Protein-ligand:  S38 params + offsets (MAE=1.05)")
print("  Metal:           S38 params (MAE=15.11, frozen)")
print()
print("Usage:")
print("  from core.modality_params import predict_routed, predict_routed_batch")
print("  result = predict_routed(uc)  # auto-routes by binding_mode")