"""
MABE Realization Engine — Sprint R2a Bootstrap (Cyclodextrin Adapter)
Run from your MABE repo root: python bootstrap_r2a.py

Requires: Sprint R1 already installed (mabe/realization/ exists)
Creates:  3 new files in mabe/realization/adapters/ and tests/
Test:     python -m pytest mabe/realization/tests/test_sprint_r2a.py -v
"""

import os
import sys

# Verify R1 exists
if not os.path.isfile("mabe/realization/__init__.py"):
    print("ERROR: Sprint R1 not found. Run bootstrap_realization.py first.")
    sys.exit(1)

FILES = {
    'mabe/realization/adapters/cyclodextrin_knowledge.py': '"""\nCyclodextrin Knowledge Base.\n\nProperties from BackSolve host registry + literature.\nAll cavity dimensions from crystallographic data.\nModification library from commercial availability + literature.\n\nData sources:\n    - Rekharsky & Inoue (Chem. Rev. 1998) — thermodynamic compilations\n    - Szejtli (Chem. Rev. 1998) — CD chemistry review\n    - BackSolve Phase 6-10 calibration dataset\n"""\n\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass, field\n\n\n@dataclass(frozen=True)\nclass CDHost:\n    """Physical properties of one cyclodextrin variant."""\n\n    name: str\n    base_type: str                     # "alpha", "beta", "gamma"\n    n_glucose: int\n\n    # ── Cavity geometry (from crystallography) ──\n    cavity_diameter_A: float           # internal diameter\n    cavity_depth_A: float              # all CDs: ~7.9 Å\n    cavity_volume_A3: float\n    outer_diameter_A: float\n    cavity_sasa_A2: float\n\n    # ── Portal properties ──\n    n_portal_HB_sites: int             # primary OH + secondary OH\n    portal_diameter_A: float           # narrower face (primary OH)\n\n    # ── Physicochemical ──\n    mw: float                          # g/mol\n    water_solubility_mM: float         # at 25°C\n    pKa_secondary_OH: float            # ~12.1 for all CDs\n\n    # ── Production ──\n    commercial: bool\n    cost_per_gram_usd: float           # approximate, bulk\n    common_suppliers: list[str]\n\n    # ── Modification state ──\n    modification: str = "native"       # "native", "HP", "Me", "SBE", etc.\n    modification_description: str = ""\n    avg_degree_of_substitution: float = 0.0\n\n    # ── BackSolve calibration ──\n    backsolve_MAE_logK: float = 0.0    # MAE from Phase 6-10\n    n_calibration_entries: int = 0\n\n\n@dataclass(frozen=True)\nclass CDModification:\n    """A chemical modification applicable to a CD."""\n\n    name: str\n    abbreviation: str\n    description: str\n    effect_on_cavity: str              # "widens", "deepens", "narrows", "unchanged"\n    effect_on_solubility: str          # "increases", "decreases", "unchanged"\n    effect_on_selectivity: str         # qualitative\n    synthesis_complexity: str          # "trivial", "moderate", "complex"\n    commercial_availability: bool\n    typical_DS: float                  # degree of substitution\n    applicable_to: list[str]           # ["alpha", "beta", "gamma"]\n\n\n# ─────────────────────────────────────────────\n# Native CD hosts (from BackSolve host registry)\n# ─────────────────────────────────────────────\n\nALPHA_CD = CDHost(\n    name="α-Cyclodextrin",\n    base_type="alpha",\n    n_glucose=6,\n    cavity_diameter_A=4.7,\n    cavity_depth_A=7.9,\n    cavity_volume_A3=174.0,\n    outer_diameter_A=14.6,\n    cavity_sasa_A2=307.0,\n    n_portal_HB_sites=12,   # 6×OH-2 + 6×OH-3\n    portal_diameter_A=4.7,\n    mw=972.84,\n    water_solubility_mM=149.0,  # 145 mg/mL\n    pKa_secondary_OH=12.1,\n    commercial=True,\n    cost_per_gram_usd=0.50,\n    common_suppliers=["Sigma-Aldrich", "TCI", "Wacker"],\n    backsolve_MAE_logK=0.62,\n    n_calibration_entries=14,\n)\n\nBETA_CD = CDHost(\n    name="β-Cyclodextrin",\n    base_type="beta",\n    n_glucose=7,\n    cavity_diameter_A=6.0,\n    cavity_depth_A=7.9,\n    cavity_volume_A3=262.0,\n    outer_diameter_A=15.4,\n    cavity_sasa_A2=427.0,\n    n_portal_HB_sites=14,\n    portal_diameter_A=6.0,\n    mw=1134.98,\n    water_solubility_mM=16.3,  # 18.5 mg/mL — notoriously low\n    pKa_secondary_OH=12.1,\n    commercial=True,\n    cost_per_gram_usd=0.15,\n    common_suppliers=["Sigma-Aldrich", "TCI", "Wacker", "Roquette"],\n    backsolve_MAE_logK=0.37,\n    n_calibration_entries=25,\n)\n\nGAMMA_CD = CDHost(\n    name="γ-Cyclodextrin",\n    base_type="gamma",\n    n_glucose=8,\n    cavity_diameter_A=7.5,\n    cavity_depth_A=7.9,\n    cavity_volume_A3=427.0,\n    outer_diameter_A=17.5,\n    cavity_sasa_A2=590.0,\n    n_portal_HB_sites=16,\n    portal_diameter_A=7.5,\n    mw=1297.12,\n    water_solubility_mM=178.0,  # 232 mg/mL\n    pKa_secondary_OH=12.1,\n    commercial=True,\n    cost_per_gram_usd=1.00,\n    common_suppliers=["Sigma-Aldrich", "TCI", "Wacker"],\n    backsolve_MAE_logK=0.61,\n    n_calibration_entries=9,\n)\n\n# ─────────────────────────────────────────────\n# Modified CDs\n# ─────────────────────────────────────────────\n\nHP_BETA_CD = CDHost(\n    name="HP-β-Cyclodextrin",\n    base_type="beta",\n    n_glucose=7,\n    cavity_diameter_A=6.0,  # cavity unchanged\n    cavity_depth_A=8.5,     # slightly deeper due to HP groups\n    cavity_volume_A3=290.0, # ~10% larger effective cavity\n    outer_diameter_A=16.0,\n    cavity_sasa_A2=440.0,\n    n_portal_HB_sites=14,\n    portal_diameter_A=6.2,\n    mw=1396.0,  # average, DS-dependent\n    water_solubility_mM=500.0,  # >>β-CD, major advantage\n    pKa_secondary_OH=12.1,\n    commercial=True,\n    cost_per_gram_usd=0.80,\n    common_suppliers=["Sigma-Aldrich", "Roquette", "Ashland"],\n    modification="HP",\n    modification_description="Hydroxypropyl substitution at O-2, O-3, O-6",\n    avg_degree_of_substitution=4.5,\n    backsolve_MAE_logK=0.50,  # estimated, fewer calibration entries\n    n_calibration_entries=5,\n)\n\nME_BETA_CD = CDHost(\n    name="Me-β-Cyclodextrin",\n    base_type="beta",\n    n_glucose=7,\n    cavity_diameter_A=6.0,\n    cavity_depth_A=8.2,\n    cavity_volume_A3=280.0,\n    outer_diameter_A=15.8,\n    cavity_sasa_A2=435.0,\n    n_portal_HB_sites=7,    # methylation removes half the OH groups\n    portal_diameter_A=6.0,\n    mw=1331.36,  # heptakis(2,6-di-O-methyl)\n    water_solubility_mM=570.0,\n    pKa_secondary_OH=12.5,  # remaining OHs\n    commercial=True,\n    cost_per_gram_usd=2.00,\n    common_suppliers=["Sigma-Aldrich", "TCI"],\n    modification="Me",\n    modification_description="Methylation at O-2 and O-6",\n    avg_degree_of_substitution=12.0,  # ~12/21 positions\n    n_calibration_entries=3,\n)\n\nSBE_BETA_CD = CDHost(\n    name="SBE-β-Cyclodextrin",\n    base_type="beta",\n    n_glucose=7,\n    cavity_diameter_A=6.0,\n    cavity_depth_A=8.8,\n    cavity_volume_A3=300.0,\n    outer_diameter_A=16.5,\n    cavity_sasa_A2=450.0,\n    n_portal_HB_sites=14,\n    portal_diameter_A=6.5,\n    mw=2163.0,  # Captisol average\n    water_solubility_mM=700.0,  # extremely soluble\n    pKa_secondary_OH=12.1,\n    commercial=True,\n    cost_per_gram_usd=15.00,  # pharmaceutical grade, expensive\n    common_suppliers=["Ligand/Captisol", "Sigma-Aldrich"],\n    modification="SBE",\n    modification_description="Sulfobutyl ether at O-6 (anionic)",\n    avg_degree_of_substitution=6.5,\n    n_calibration_entries=2,\n)\n\n# ─────────────────────────────────────────────\n# All hosts indexed\n# ─────────────────────────────────────────────\n\nCD_HOSTS: dict[str, CDHost] = {\n    "alpha-CD": ALPHA_CD,\n    "beta-CD": BETA_CD,\n    "gamma-CD": GAMMA_CD,\n    "HP-beta-CD": HP_BETA_CD,\n    "Me-beta-CD": ME_BETA_CD,\n    "SBE-beta-CD": SBE_BETA_CD,\n}\n\nNATIVE_CDS: list[CDHost] = [ALPHA_CD, BETA_CD, GAMMA_CD]\n\nALL_CDS: list[CDHost] = list(CD_HOSTS.values())\n\n# ─────────────────────────────────────────────\n# Modification library\n# ─────────────────────────────────────────────\n\nCD_MODIFICATIONS: list[CDModification] = [\n    CDModification(\n        name="Hydroxypropylation",\n        abbreviation="HP",\n        description="Hydroxypropyl groups at O-2, O-3, O-6. "\n                    "Dramatically improves water solubility while preserving cavity.",\n        effect_on_cavity="slightly widens",\n        effect_on_solubility="increases",\n        effect_on_selectivity="slightly reduces (DS heterogeneity)",\n        synthesis_complexity="moderate",\n        commercial_availability=True,\n        typical_DS=4.5,\n        applicable_to=["alpha", "beta", "gamma"],\n    ),\n    CDModification(\n        name="Methylation",\n        abbreviation="Me",\n        description="Methyl groups at O-2 and O-6. "\n                    "Extends cavity depth, makes more hydrophobic interior.",\n        effect_on_cavity="deepens",\n        effect_on_solubility="increases",\n        effect_on_selectivity="enhances hydrophobic selectivity",\n        synthesis_complexity="moderate",\n        commercial_availability=True,\n        typical_DS=12.0,\n        applicable_to=["alpha", "beta", "gamma"],\n    ),\n    CDModification(\n        name="Sulfobutyl ether",\n        abbreviation="SBE",\n        description="Anionic sulfobutyl ether groups at O-6. "\n                    "Adds electrostatic interactions, high solubility.",\n        effect_on_cavity="extends with flexible arms",\n        effect_on_solubility="increases",\n        effect_on_selectivity="enhances cation binding via charge",\n        synthesis_complexity="complex",\n        commercial_availability=True,\n        typical_DS=6.5,\n        applicable_to=["beta"],\n    ),\n    CDModification(\n        name="Amino substitution",\n        abbreviation="NH2",\n        description="Primary amine at C-6. Cationic at neutral pH. "\n                    "Click chemistry handle via reductive amination.",\n        effect_on_cavity="unchanged",\n        effect_on_solubility="increases",\n        effect_on_selectivity="adds anion binding capability",\n        synthesis_complexity="moderate",\n        commercial_availability=True,\n        typical_DS=1.0,\n        applicable_to=["alpha", "beta", "gamma"],\n    ),\n    CDModification(\n        name="Tosylation (C6-OTs)",\n        abbreviation="OTs",\n        description="Tosylate at C-6 primary OH. Key intermediate for "\n                    "azide, thiol, amine conversions. Click handle precursor.",\n        effect_on_cavity="unchanged",\n        effect_on_solubility="decreases",\n        effect_on_selectivity="unchanged (handle, not binding modification)",\n        synthesis_complexity="trivial",\n        commercial_availability=True,\n        typical_DS=1.0,\n        applicable_to=["alpha", "beta", "gamma"],\n    ),\n    CDModification(\n        name="Azide (C6-N3)",\n        abbreviation="N3",\n        description="Azide at C-6 via tosylate displacement. "\n                    "CuAAC click handle for conjugation to scaffolds.",\n        effect_on_cavity="unchanged",\n        effect_on_solubility="slightly decreases",\n        effect_on_selectivity="unchanged (conjugation handle)",\n        synthesis_complexity="moderate",\n        commercial_availability=True,\n        typical_DS=1.0,\n        applicable_to=["alpha", "beta", "gamma"],\n    ),\n]\n\n\n# ─────────────────────────────────────────────\n# BackSolve calibrated parameters for CD binding\n# ─────────────────────────────────────────────\n\nBACKSOLVE_CD_PARAMS = {\n    # From Phase 6-10 joint calibration (R²=0.850, MAE=0.74)\n    "gamma_hydrophobic": -0.0291,       # kJ/mol per Å² buried SASA\n    "eps_neutral_hbond": -8.027,        # kJ/mol per neutral H-bond\n    "eps_charge_assisted_hbond": -7.173,# kJ/mol per charge-assisted H-bond\n    "water_penalty_per_hb": 3.995,      # kJ/mol per H-bond to displace water\n    "water_displacement_bonus": 1.332,  # kJ/mol per high-energy water displaced\n    "eps_rotor": 2.481,                 # kJ/mol per frozen rotor (penalty)\n    "f_partial_freeze": 0.534,          # fraction of rotors that freeze\n    "k_shape": -4.997,                  # shape complementarity coefficient\n    "PC_optimal": 0.591,                # optimal packing coefficient (Rebek ~0.55)\n    "sigma_PC": 0.050,                  # packing coefficient Gaussian width\n}\n\n\ndef select_best_cd(\n    guest_volume_A3: float,\n    guest_is_charged: bool = False,\n    require_water_soluble: bool = True,\n    require_click_handle: bool = False,\n) -> list[tuple[CDHost, float, str]]:\n    """\n    Quick CD selection from guest volume using Rebek\'s 55% packing rule.\n\n    Returns list of (CDHost, packing_coefficient, rationale) sorted by\n    how close PC is to optimal.\n    """\n    results = []\n    candidates = ALL_CDS if not require_water_soluble else [\n        cd for cd in ALL_CDS if cd.water_solubility_mM > 50.0\n    ]\n\n    for cd in candidates:\n        pc = guest_volume_A3 / cd.cavity_volume_A3\n        # Rebek\'s rule: optimal packing ~0.55-0.59\n        deviation = abs(pc - BACKSOLVE_CD_PARAMS["PC_optimal"])\n\n        rationale_parts = [f"PC={pc:.2f}"]\n        if pc < 0.3:\n            rationale_parts.append("guest too small — poor shape complementarity")\n        elif pc > 0.8:\n            rationale_parts.append("guest too large — steric clash likely")\n        elif deviation < 0.05:\n            rationale_parts.append("excellent packing (Rebek sweet spot)")\n        elif deviation < 0.10:\n            rationale_parts.append("good packing")\n        else:\n            rationale_parts.append("suboptimal packing")\n\n        if guest_is_charged and cd.modification == "SBE":\n            rationale_parts.append("SBE anionic arms complement cationic guest")\n\n        results.append((cd, pc, "; ".join(rationale_parts)))\n\n    # Sort by closeness to optimal PC\n    results.sort(key=lambda x: abs(x[1] - BACKSOLVE_CD_PARAMS["PC_optimal"]))\n    return results\n',
    'mabe/realization/adapters/cyclodextrin_adapter.py': '"""\nCyclodextrin Adapter — Layer 4 Implementation.\n\nTakes an InteractionGeometrySpec describing a hydrophobic inclusion pocket\nand designs a cyclodextrin-based realization.\n\nDesign logic:\n    1. Map spec cavity volume → α/β/γ-CD by packing coefficient\n    2. Score each CD variant (native + modified) against spec\n    3. Select modifications based on solubility, charge, conjugation needs\n    4. Produce CyclodextrinFabSpec with selection rationale + sourcing\n\nPhysics connection:\n    - Packing coefficient → BackSolve Phase 10 (shape complementarity)\n    - Hydrophobic SASA → BackSolve Phase 6 (γ_hydrophobic)\n    - H-bond count → BackSolve Phase 7 (ε_neutral, ε_charge_assisted)\n    - Rotor freezing → BackSolve Phase 9 (ε_rotor, f_partial)\n"""\n\nfrom __future__ import annotations\n\nimport hashlib\nimport math\nfrom dataclasses import dataclass, field\nfrom typing import Optional\n\nfrom mabe.realization.adapters.base import RealizationAdapter, ValidationReport\nfrom mabe.realization.adapters.cyclodextrin_knowledge import (\n    ALL_CDS,\n    BACKSOLVE_CD_PARAMS,\n    CD_HOSTS,\n    CD_MODIFICATIONS,\n    CDHost,\n    CDModification,\n    NATIVE_CDS,\n    select_best_cd,\n)\nfrom mabe.realization.models import (\n    ApplicationContext,\n    CavityDimensions,\n    CavityShape,\n    DeviationReport,\n    FabricationSpec,\n    InteractionGeometrySpec,\n    RealizationScore,\n    Solvent,\n)\nfrom mabe.realization.registry.material_registry import MaterialCapability\n\n\n# ─────────────────────────────────────────────\n# CyclodextrinFabSpec — CD-specific fabrication output\n# ─────────────────────────────────────────────\n\n@dataclass\nclass CyclodextrinFabSpec(FabricationSpec):\n    """Fabrication spec for a cyclodextrin-based pocket."""\n\n    # ── CD selection ──\n    selected_cd: str = ""\n    base_type: str = ""\n    cavity_diameter_A: float = 0.0\n    cavity_volume_A3: float = 0.0\n\n    # ── Packing analysis ──\n    packing_coefficient: float = 0.0\n    packing_quality: str = ""\n\n    # ── Modification ──\n    modifications: list[str] = field(default_factory=list)\n    modification_rationale: list[str] = field(default_factory=list)\n\n    # ── Binding prediction (from BackSolve params) ──\n    predicted_dG_kJ_mol: float = 0.0\n    predicted_logK: float = 0.0\n    prediction_confidence: str = ""\n\n    # ── Conjugation ──\n    click_handle: str = ""\n    click_handle_synthesis: str = ""\n\n    # ── Sourcing ──\n    supplier: str = ""\n    catalog_note: str = ""\n\n\n# ─────────────────────────────────────────────\n# Adapter implementation\n# ─────────────────────────────────────────────\n\nclass CyclodextrinAdapter(RealizationAdapter):\n    """\n    Designs cyclodextrin-based binding pockets.\n\n    CDs are Class A (Covalent Cavity) systems:\n        - 0.47–0.83 nm cavity diameter (α/β/γ)\n        - Truncated cone shape\n        - Hydrophobic interior, hydrophilic exterior\n        - Driven by hydrophobic burial + H-bonds at portals\n        - Rebek packing coefficient ~0.55 is optimal\n    """\n\n    def __init__(self, capability: Optional[MaterialCapability] = None):\n        if capability is None:\n            from mabe.realization.registry.material_registry import MATERIAL_REGISTRY\n            capability = MATERIAL_REGISTRY.get("cyclic_encapsulant")\n            if capability is None:\n                capability = _make_cd_capability()\n        super().__init__(capability)\n\n    def estimate_fidelity(\n        self,\n        spec: InteractionGeometrySpec,\n    ) -> RealizationScore:\n        """\n        Quick score: can a CD host this guest geometry?\n\n        Primary check: cavity volume → packing coefficient.\n        Secondary: operating conditions, solvent compatibility.\n        """\n\n        # ── Packing coefficient scan across all CDs ──\n        best_pc_dev = float("inf")\n        best_cd = None\n        best_pc = 0.0\n\n        target_vol = spec.cavity_dimensions.volume_A3\n\n        for cd in ALL_CDS:\n            pc = target_vol / cd.cavity_volume_A3\n            pc_dev = abs(pc - BACKSOLVE_CD_PARAMS["PC_optimal"])\n            if pc_dev < best_pc_dev:\n                best_pc_dev = pc_dev\n                best_cd = cd\n                best_pc = pc\n\n        # ── Physics fidelity from packing coefficient ──\n        sigma = BACKSOLVE_CD_PARAMS["sigma_PC"]\n        pc_optimal = BACKSOLVE_CD_PARAMS["PC_optimal"]\n        pc_fidelity = math.exp(-0.5 * ((best_pc - pc_optimal) / sigma) ** 2)\n\n        # ── Cavity shape compatibility ──\n        shape_compat = {\n            CavityShape.CONE: 1.0,\n            CavityShape.SPHERE: 0.9,\n            CavityShape.BARREL: 0.7,\n            CavityShape.CUSTOM: 0.6,\n            CavityShape.CLEFT: 0.3,\n            CavityShape.FLAT: 0.2,\n            CavityShape.CHANNEL: 0.1,\n        }\n        shape_score = shape_compat.get(spec.cavity_shape, 0.5)\n\n        # ── Combine into physics fidelity ──\n        physics_fidelity = pc_fidelity * 0.7 + shape_score * 0.3\n\n        # ── Size gate ──\n        if best_pc < 0.2 or best_pc > 0.9:\n            physics_fidelity *= 0.1\n\n        # ── Solvent gate ──\n        if spec.solvent not in (Solvent.AQUEOUS, Solvent.MIXED):\n            physics_fidelity *= 0.1\n\n        # ── Deviation report ──\n        spec_diameter = spec.cavity_dimensions.max_internal_diameter_A\n        cd_diameter = best_cd.cavity_diameter_A if best_cd else 0.0\n        diameter_dev = abs(spec_diameter - cd_diameter)\n\n        deviation = DeviationReport(\n            material_system="cyclodextrin",\n            element_deviations_A=[diameter_dev],\n            max_deviation_A=diameter_dev,\n            mean_deviation_A=diameter_dev,\n        )\n\n        # ── Advantages / limitations ──\n        advantages = []\n        limitations = []\n\n        if best_cd:\n            if best_cd.commercial:\n                advantages.append(\n                    f"{best_cd.name} commercially available "\n                    f"(${best_cd.cost_per_gram_usd}/g)"\n                )\n            if best_cd.water_solubility_mM > 100:\n                advantages.append(\n                    f"Good water solubility ({best_cd.water_solubility_mM:.0f} mM)"\n                )\n            if best_cd.backsolve_MAE_logK < 0.5:\n                advantages.append(\n                    f"Well-calibrated prediction "\n                    f"(MAE={best_cd.backsolve_MAE_logK:.2f} log K)"\n                )\n            if best_pc < 0.4:\n                limitations.append(f"Guest may be too small (PC={best_pc:.2f})")\n            if best_pc > 0.75:\n                limitations.append(f"Guest may be too large (PC={best_pc:.2f})")\n            if spec.solvent == Solvent.ORGANIC:\n                limitations.append("CDs require aqueous environment")\n            if (best_cd.base_type == "beta"\n                    and best_cd.modification == "native"):\n                limitations.append("Native β-CD has low water solubility (16 mM)")\n\n        return RealizationScore(\n            material_system="cyclodextrin",\n            adapter_id="CyclodextrinAdapter",\n            deviation_from_ideal=deviation,\n            physics_fidelity=max(0.0, min(1.0, physics_fidelity)),\n            synthetic_accessibility=0.95,\n            cost_score=0.90,\n            scalability=0.95,\n            operating_condition_compatibility=(\n                0.9 if spec.solvent == Solvent.AQUEOUS else 0.2\n            ),\n            reusability_score=0.3,\n            composite_score=0.0,\n            confidence=(\n                0.85 if best_cd and best_cd.n_calibration_entries > 10 else 0.60\n            ),\n            advantages=advantages,\n            limitations=limitations,\n            feasible=0.15 <= best_pc <= 0.95,\n            infeasibility_reason=(\n                f"No CD has suitable cavity (best PC={best_pc:.2f})"\n                if best_pc < 0.15 or best_pc > 0.95 else None\n            ),\n        )\n\n    def design(\n        self,\n        spec: InteractionGeometrySpec,\n    ) -> CyclodextrinFabSpec:\n        """\n        Full CD pocket design.\n\n        1. Rank all CDs by packing coefficient\n        2. Apply modification logic\n        3. Predict binding affinity\n        4. Specify conjugation handle\n        5. Output fab spec\n        """\n\n        target_vol = spec.cavity_dimensions.volume_A3\n        spec_hash = hashlib.md5(str(spec).encode()).hexdigest()[:12]\n\n        # ── Step 1: Rank native CDs by packing (no solubility filter) ──\n        ranked = select_best_cd(\n            guest_volume_A3=target_vol,\n            require_water_soluble=False,  # pick best physics first\n        )\n\n        if not ranked:\n            return self._empty_fab(spec_hash, "No suitable CD found")\n\n        # Find best native CD (not modified)\n        best_cd, best_pc, _rationale = ranked[0]\n        for cd, pc, rat in ranked:\n            if cd.modification == "native":\n                best_cd, best_pc, _rationale = cd, pc, rat\n                break\n\n        # ── Step 2: Modification selection ──\n        modifications = []\n        mod_rationale = []\n\n        # Solubility fix: if native CD has low solubility in aqueous app\n        if (best_cd.modification == "native"\n                and best_cd.water_solubility_mM < 50\n                and spec.solvent in (Solvent.AQUEOUS, Solvent.MIXED)):\n            modifications.append("HP")\n            mod_rationale.append(\n                "Hydroxypropylation recommended: native "\n                f"{best_cd.base_type}-CD solubility "\n                f"({best_cd.water_solubility_mM:.0f} mM) may limit application. "\n                f"HP-{best_cd.base_type}-CD provides >500 mM with minimal "\n                "cavity change."\n            )\n            # Switch to HP variant if available\n            hp_key = f"HP-{best_cd.base_type}-CD"\n            if hp_key in CD_HOSTS:\n                best_cd = CD_HOSTS[hp_key]\n                best_pc = target_vol / best_cd.cavity_volume_A3\n\n        # Charge complementarity\n        charged_donors = [\n            d for d in spec.donor_positions if d.charge_state != 0\n        ]\n        if charged_donors and best_cd.base_type == "beta":\n            if any(d.charge_state > 0 for d in charged_donors):\n                if best_cd.modification != "SBE":\n                    modifications.append("SBE")\n                    mod_rationale.append(\n                        "SBE modification: anionic sulfobutyl arms for "\n                        "electrostatic complementarity with cationic guest."\n                    )\n\n        # Conjugation handle for deployment applications\n        click_handle = "none"\n        click_synthesis = ""\n        if spec.target_application in (\n            ApplicationContext.DIAGNOSTIC,\n            ApplicationContext.REMEDIATION,\n            ApplicationContext.SEPARATION,\n        ):\n            modifications.append("N3")\n            mod_rationale.append(\n                "C6-azide handle for CuAAC click conjugation to scaffold."\n            )\n            click_handle = "C6-azide"\n            click_synthesis = (\n                "1. Monotosylation: CD + TsCl (1.0 eq), NaOH, 0°C, 2h\\n"\n                "2. Azide displacement: OTs-CD + NaN3 (3 eq), DMF, 80°C, 12h\\n"\n                "3. Purification: dialysis (MWCO 500) + lyophilization"\n            )\n\n        # ── Step 3: Binding prediction ──\n        predicted_dG, predicted_logK, confidence = self._predict_binding(\n            best_cd, target_vol, spec\n        )\n\n        # ── Step 4: Packing quality label ──\n        pc_dev = abs(best_pc - BACKSOLVE_CD_PARAMS["PC_optimal"])\n        if pc_dev < 0.03:\n            packing_quality = "excellent"\n        elif pc_dev < 0.08:\n            packing_quality = "good"\n        elif pc_dev < 0.15:\n            packing_quality = "suboptimal"\n        else:\n            packing_quality = "poor"\n\n        # ── Step 5: Characterization plan ──\n        validation = [\n            "ITC for Ka, ΔH, ΔS",\n            "1H NMR titration (ROESY for inclusion geometry)",\n        ]\n        if click_handle != "none":\n            validation.append("FTIR: azide stretch at 2100 cm⁻¹")\n            validation.append("MALDI-TOF: confirm mono-substitution MW")\n\n        expected = {\n            "Ka_M_inv": 10 ** predicted_logK if predicted_logK < 10 else 1e10,\n            "dG_kJ_mol": predicted_dG,\n            "stoichiometry": "1:1",\n        }\n\n        # ── Step 6: Synthesis steps ──\n        steps = [f"Procure {best_cd.name} from {best_cd.common_suppliers[0]}"]\n        if "HP" in modifications and best_cd.modification != "HP":\n            steps.append("HP modification: propylene oxide, NaOH, 40°C, 24h")\n        if "N3" in modifications:\n            steps.append("Monotosylation: TsCl (1.0 eq), NaOH, 0°C, 2h")\n            steps.append("Azide displacement: NaN3 (3 eq), DMF, 80°C, 12h")\n            steps.append("Purification: dialysis + lyophilization")\n        if not any(m in modifications for m in ["HP", "Me", "SBE", "NH2", "N3"]):\n            steps.append("Use as-is (native CD)")\n\n        return CyclodextrinFabSpec(\n            material_system="cyclodextrin",\n            geometry_spec_hash=spec_hash,\n            predicted_pocket_geometry=CavityDimensions(\n                volume_A3=best_cd.cavity_volume_A3,\n                aperture_A=best_cd.portal_diameter_A,\n                depth_A=best_cd.cavity_depth_A,\n                max_internal_diameter_A=best_cd.cavity_diameter_A,\n            ),\n            predicted_deviation_from_ideal_A=abs(\n                spec.cavity_dimensions.volume_A3 - best_cd.cavity_volume_A3\n            ) ** (1/3),\n            synthesis_steps=steps,\n            estimated_yield=0.85 if not modifications else 0.60,\n            estimated_cost_per_unit=best_cd.cost_per_gram_usd * (\n                1.0 + 0.5 * len(modifications)\n            ),\n            estimated_time="1 day" if not modifications else "3–5 days",\n            validation_experiments=validation,\n            expected_observables=expected,\n            selected_cd=best_cd.name,\n            base_type=best_cd.base_type,\n            cavity_diameter_A=best_cd.cavity_diameter_A,\n            cavity_volume_A3=best_cd.cavity_volume_A3,\n            packing_coefficient=best_pc,\n            packing_quality=packing_quality,\n            modifications=modifications,\n            modification_rationale=mod_rationale,\n            predicted_dG_kJ_mol=predicted_dG,\n            predicted_logK=predicted_logK,\n            prediction_confidence=confidence,\n            click_handle=click_handle,\n            click_handle_synthesis=click_synthesis,\n            supplier=best_cd.common_suppliers[0],\n            catalog_note=f"{best_cd.name}, ≥97%, {best_cd.mw:.0f} g/mol",\n        )\n\n    def validate_design(self, fab: FabricationSpec) -> ValidationReport:\n        """Check CD design for internal consistency."""\n\n        if not isinstance(fab, CyclodextrinFabSpec):\n            return ValidationReport(\n                valid=False,\n                issues=["Not a CyclodextrinFabSpec"],\n                warnings=[],\n            )\n\n        issues = []\n        warnings = []\n\n        if fab.packing_coefficient < 0.2:\n            issues.append(\n                f"PC {fab.packing_coefficient:.2f} too low — "\n                "guest will not be retained"\n            )\n        elif fab.packing_coefficient > 0.85:\n            issues.append(\n                f"PC {fab.packing_coefficient:.2f} too high — "\n                "steric clash prevents inclusion"\n            )\n\n        if fab.packing_coefficient < 0.4:\n            warnings.append(\n                f"Low packing ({fab.packing_coefficient:.2f}): "\n                "weak binding expected"\n            )\n        if fab.packing_coefficient > 0.7:\n            warnings.append(\n                f"High packing ({fab.packing_coefficient:.2f}): "\n                "slow kinetics possible"\n            )\n\n        if "SBE" in fab.modifications and fab.base_type != "beta":\n            issues.append("SBE modification only available for β-CD")\n\n        if fab.predicted_dG_kJ_mol > 0:\n            warnings.append("Predicted ΔG > 0: unfavorable binding")\n\n        return ValidationReport(\n            valid=len(issues) == 0,\n            issues=issues,\n            warnings=warnings,\n            confidence=0.85 if fab.prediction_confidence == "high" else 0.60,\n        )\n\n    # ─────────────────────────────────────────\n    # Internal\n    # ─────────────────────────────────────────\n\n    def _predict_binding(\n        self,\n        cd: CDHost,\n        guest_volume_A3: float,\n        spec: InteractionGeometrySpec,\n    ) -> tuple[float, float, str]:\n        """\n        Predict binding ΔG using BackSolve calibrated parameters.\n\n        Returns (ΔG kJ/mol, log K, confidence).\n        """\n        params = BACKSOLVE_CD_PARAMS\n\n        # ── Hydrophobic burial ──\n        guest_radius = (3 * guest_volume_A3 / (4 * math.pi)) ** (1/3)\n        estimated_sasa = 4 * math.pi * guest_radius ** 2\n        burial_fraction = min(\n            1.0, cd.cavity_depth_A / (2 * guest_radius + 1)\n        )\n        buried_sasa = estimated_sasa * burial_fraction\n        dG_hydrophobic = params["gamma_hydrophobic"] * buried_sasa\n\n        # ── Shape complementarity ──\n        pc = guest_volume_A3 / cd.cavity_volume_A3\n        pc_penalty = params["k_shape"] * math.exp(\n            -0.5 * ((pc - params["PC_optimal"]) / params["sigma_PC"]) ** 2\n        )\n\n        # ── H-bond estimate ──\n        n_hbonds = 0\n        if spec.h_bond_network and spec.h_bond_network.donors:\n            n_hbonds = min(len(spec.h_bond_network.donors), 3)\n        dG_hbond = n_hbonds * params["eps_neutral_hbond"]\n        dG_water = n_hbonds * params["water_penalty_per_hb"]\n\n        # ── Conformational entropy ──\n        n_rotors = len([\n            d for d in spec.donor_positions\n            if d.coordination_role in ("h_bond_donor", "h_bond_acceptor")\n        ])\n        dG_entropy = params["eps_rotor"] * n_rotors * params["f_partial_freeze"]\n\n        # ── Total ──\n        dG = dG_hydrophobic + pc_penalty + dG_hbond + dG_water + dG_entropy\n\n        RT = 8.314e-3 * 298.15\n        logK = -dG / (2.303 * RT)\n\n        if cd.n_calibration_entries >= 15:\n            confidence = "high"\n        elif cd.n_calibration_entries >= 5:\n            confidence = "medium"\n        else:\n            confidence = "low"\n\n        return dG, logK, confidence\n\n    def _empty_fab(self, spec_hash: str, reason: str) -> CyclodextrinFabSpec:\n        """Return an empty fab spec when design fails."""\n        return CyclodextrinFabSpec(\n            material_system="cyclodextrin",\n            geometry_spec_hash=spec_hash,\n            predicted_pocket_geometry=CavityDimensions(0, 0, 0, 0),\n            predicted_deviation_from_ideal_A=float("inf"),\n            synthesis_steps=[f"DESIGN FAILED: {reason}"],\n        )\n\n\ndef _make_cd_capability() -> MaterialCapability:\n    """Build a CD-specific MaterialCapability."""\n    return MaterialCapability(\n        system_id="cyclodextrin",\n        physics_class="covalent_cavity",\n        adapter_class="CyclodextrinAdapter",\n        min_pocket_size_nm=0.47,\n        max_pocket_size_nm=0.83,\n        achievable_symmetries=["Cn", "Cnv"],\n        max_donor_count=16,\n        donor_types_available=["O"],\n        positioning_precision_A=0.10,\n        rigidity_range=("semi-rigid", "rigid"),\n        pH_stability=(2.0, 12.0),\n        thermal_stability_K=(273.0, 500.0),\n        solvent_compatibility=["aqueous", "mixed"],\n        min_practical_scale="µmol",\n        max_practical_scale="kmol",\n        cost_per_unit_range=(0.15, 15.0),\n        typical_synthesis_time="1–5 days",\n        literature_validation_rate=0.80,\n        literature_examples=20000,\n        design_tools_available=["RDKit"],\n        known_strengths=[\n            "Commodity chemical",\n            "BackSolve-calibrated (MAE=0.37 log K for β-CD)",\n            "Click-handle conjugation well-precedented",\n        ],\n        known_limitations=[\n            "Truncated cone shape only",\n            "Aqueous-only",\n            "Limited selectivity for hydrophilic guests",\n        ],\n    )\n',
    'mabe/realization/tests/test_sprint_r2a.py': '"""\nSprint R2a Test Suite — Cyclodextrin Adapter.\n\nTests:\n    - Knowledge base integrity (CD properties, modifications)\n    - Packing coefficient selection (α/β/γ by guest volume)\n    - Full design pipeline (spec → CyclodextrinFabSpec)\n    - Modification logic (solubility fix, charge, click handle)\n    - Binding prediction (uses BackSolve params)\n    - Validation (PC bounds, internal consistency)\n"""\n\nimport math\nimport pytest\n\nfrom mabe.realization.adapters.cyclodextrin_adapter import (\n    CyclodextrinAdapter,\n    CyclodextrinFabSpec,\n)\nfrom mabe.realization.adapters.cyclodextrin_knowledge import (\n    ALPHA_CD,\n    ALL_CDS,\n    BACKSOLVE_CD_PARAMS,\n    BETA_CD,\n    CD_HOSTS,\n    CD_MODIFICATIONS,\n    GAMMA_CD,\n    HP_BETA_CD,\n    NATIVE_CDS,\n    select_best_cd,\n)\nfrom mabe.realization.models import (\n    ApplicationContext,\n    CavityDimensions,\n    CavityShape,\n    DonorPosition,\n    InteractionGeometrySpec,\n    ScaleClass,\n    Solvent,\n)\n\n\n# ─────────────────────────────────────────────\n# Spec fixtures\n# ─────────────────────────────────────────────\n\ndef make_beta_cd_guest_spec() -> InteractionGeometrySpec:\n    """\n    Guest that fits β-CD: ~155 Å³ volume.\n    PC = 155/262 = 0.59 — right in the Rebek sweet spot.\n    Think: adamantane, p-nitrophenol, ibuprofen-sized.\n    """\n    return InteractionGeometrySpec(\n        cavity_shape=CavityShape.SPHERE,\n        cavity_dimensions=CavityDimensions(\n            volume_A3=155.0,\n            aperture_A=6.0,\n            depth_A=7.0,\n            max_internal_diameter_A=6.5,\n        ),\n        symmetry="none",\n        donor_positions=[],\n        pocket_scale_nm=0.6,\n        pH_range=(4.0, 9.0),\n        temperature_range_K=(288.0, 310.0),\n        solvent=Solvent.AQUEOUS,\n        target_application=ApplicationContext.RESEARCH,\n        required_scale=ScaleClass.UMOL,\n    )\n\n\ndef make_alpha_cd_guest_spec() -> InteractionGeometrySpec:\n    """Small guest that fits α-CD: ~100 Å³ (PC = 100/174 = 0.57)."""\n    return InteractionGeometrySpec(\n        cavity_shape=CavityShape.SPHERE,\n        cavity_dimensions=CavityDimensions(\n            volume_A3=100.0,\n            aperture_A=4.5,\n            depth_A=6.0,\n            max_internal_diameter_A=4.5,\n        ),\n        symmetry="none",\n        pocket_scale_nm=0.47,\n        solvent=Solvent.AQUEOUS,\n        target_application=ApplicationContext.RESEARCH,\n        required_scale=ScaleClass.UMOL,\n    )\n\n\ndef make_gamma_cd_guest_spec() -> InteractionGeometrySpec:\n    """Large guest that fits γ-CD: ~250 Å³ (PC = 250/427 = 0.59)."""\n    return InteractionGeometrySpec(\n        cavity_shape=CavityShape.SPHERE,\n        cavity_dimensions=CavityDimensions(\n            volume_A3=250.0,\n            aperture_A=7.0,\n            depth_A=7.5,\n            max_internal_diameter_A=7.5,\n        ),\n        symmetry="none",\n        pocket_scale_nm=0.75,\n        solvent=Solvent.AQUEOUS,\n        target_application=ApplicationContext.RESEARCH,\n        required_scale=ScaleClass.UMOL,\n    )\n\n\ndef make_diagnostic_spec() -> InteractionGeometrySpec:\n    """β-CD guest with diagnostic application → should get click handle."""\n    return InteractionGeometrySpec(\n        cavity_shape=CavityShape.SPHERE,\n        cavity_dimensions=CavityDimensions(\n            volume_A3=155.0,\n            aperture_A=6.0,\n            depth_A=7.0,\n            max_internal_diameter_A=6.5,\n        ),\n        symmetry="none",\n        pocket_scale_nm=0.6,\n        solvent=Solvent.AQUEOUS,\n        target_application=ApplicationContext.DIAGNOSTIC,\n        required_scale=ScaleClass.UMOL,\n    )\n\n\ndef make_cationic_guest_spec() -> InteractionGeometrySpec:\n    """Cationic guest → should trigger SBE modification."""\n    return InteractionGeometrySpec(\n        cavity_shape=CavityShape.SPHERE,\n        cavity_dimensions=CavityDimensions(\n            volume_A3=155.0,\n            aperture_A=6.0,\n            depth_A=7.0,\n            max_internal_diameter_A=6.5,\n        ),\n        symmetry="none",\n        donor_positions=[\n            DonorPosition(\n                atom_type="N",\n                coordination_role="h_bond_donor",\n                position_vector_A=(0.0, 3.0, 0.0),\n                tolerance_A=0.5,\n                required_hybridization="sp3",\n                charge_state=1.0,\n            ),\n        ],\n        pocket_scale_nm=0.6,\n        solvent=Solvent.AQUEOUS,\n        target_application=ApplicationContext.RESEARCH,\n        required_scale=ScaleClass.UMOL,\n    )\n\n\ndef make_too_large_spec() -> InteractionGeometrySpec:\n    """Guest too large for any CD (800 Å³, PC > 1.0 for all)."""\n    return InteractionGeometrySpec(\n        cavity_shape=CavityShape.SPHERE,\n        cavity_dimensions=CavityDimensions(\n            volume_A3=800.0,\n            aperture_A=12.0,\n            depth_A=10.0,\n            max_internal_diameter_A=12.0,\n        ),\n        symmetry="none",\n        pocket_scale_nm=1.2,\n        solvent=Solvent.AQUEOUS,\n        target_application=ApplicationContext.RESEARCH,\n        required_scale=ScaleClass.UMOL,\n    )\n\n\n# ─────────────────────────────────────────────\n# Test 1: Knowledge Base\n# ─────────────────────────────────────────────\n\nclass TestKnowledgeBase:\n\n    def test_three_native_cds(self):\n        assert len(NATIVE_CDS) == 3\n\n    def test_six_total_cds(self):\n        assert len(ALL_CDS) == 6\n\n    def test_alpha_smallest_cavity(self):\n        assert ALPHA_CD.cavity_volume_A3 < BETA_CD.cavity_volume_A3 < GAMMA_CD.cavity_volume_A3\n\n    def test_cavity_diameters_increase(self):\n        assert ALPHA_CD.cavity_diameter_A < BETA_CD.cavity_diameter_A < GAMMA_CD.cavity_diameter_A\n\n    def test_beta_cd_low_solubility(self):\n        """β-CD notoriously has low water solubility."""\n        assert BETA_CD.water_solubility_mM < 20\n\n    def test_hp_beta_high_solubility(self):\n        """HP-β-CD solves the solubility problem."""\n        assert HP_BETA_CD.water_solubility_mM > 400\n\n    def test_all_cds_commercial(self):\n        for cd in ALL_CDS:\n            assert cd.commercial\n\n    def test_backsolve_params_present(self):\n        assert "gamma_hydrophobic" in BACKSOLVE_CD_PARAMS\n        assert "PC_optimal" in BACKSOLVE_CD_PARAMS\n        assert "k_shape" in BACKSOLVE_CD_PARAMS\n\n    def test_pc_optimal_near_rebek(self):\n        """Rebek\'s 55% rule: optimal PC ≈ 0.55."""\n        assert 0.50 < BACKSOLVE_CD_PARAMS["PC_optimal"] < 0.65\n\n    def test_modifications_library(self):\n        assert len(CD_MODIFICATIONS) >= 5\n        abbrevs = {m.abbreviation for m in CD_MODIFICATIONS}\n        assert "HP" in abbrevs\n        assert "Me" in abbrevs\n        assert "N3" in abbrevs\n\n\n# ─────────────────────────────────────────────\n# Test 2: Packing Coefficient Selection\n# ─────────────────────────────────────────────\n\nclass TestPackingSelection:\n\n    def test_beta_volume_selects_beta(self):\n        """155 Å³ guest → β-CD (PC ≈ 0.59)."""\n        results = select_best_cd(155.0)\n        best_cd, pc, _ = results[0]\n        assert best_cd.base_type == "beta"\n        assert 0.45 < pc < 0.70\n\n    def test_small_volume_selects_alpha(self):\n        """100 Å³ guest → α-CD (PC ≈ 0.57)."""\n        results = select_best_cd(100.0)\n        best_cd, pc, _ = results[0]\n        assert best_cd.base_type == "alpha"\n        assert 0.45 < pc < 0.70\n\n    def test_large_volume_selects_gamma(self):\n        """250 Å³ guest → γ-CD (PC ≈ 0.59)."""\n        results = select_best_cd(250.0)\n        best_cd, pc, _ = results[0]\n        assert best_cd.base_type == "gamma"\n\n    def test_results_sorted_by_pc_optimality(self):\n        """Results should be sorted by closeness to optimal PC."""\n        results = select_best_cd(155.0)\n        deviations = [\n            abs(pc - BACKSOLVE_CD_PARAMS["PC_optimal"])\n            for _, pc, _ in results\n        ]\n        assert deviations == sorted(deviations)\n\n    def test_water_soluble_filter(self):\n        """With require_water_soluble, native β-CD excluded."""\n        results_all = select_best_cd(155.0, require_water_soluble=False)\n        results_soluble = select_best_cd(155.0, require_water_soluble=True)\n        # Native β-CD (16 mM) should be excluded from soluble list\n        soluble_names = {cd.name for cd, _, _ in results_soluble}\n        assert "β-Cyclodextrin" not in soluble_names\n\n\n# ─────────────────────────────────────────────\n# Test 3: Adapter estimate_fidelity\n# ─────────────────────────────────────────────\n\nclass TestEstimateFidelity:\n\n    def setup_method(self):\n        self.adapter = CyclodextrinAdapter()\n\n    def test_good_guest_high_fidelity(self):\n        spec = make_beta_cd_guest_spec()\n        score = self.adapter.estimate_fidelity(spec)\n        assert score.physics_fidelity > 0.5\n        assert score.feasible\n\n    def test_too_large_guest_low_fidelity(self):\n        spec = make_too_large_spec()\n        score = self.adapter.estimate_fidelity(spec)\n        assert score.physics_fidelity < 0.3\n\n    def test_organic_solvent_penalized(self):\n        spec = make_beta_cd_guest_spec()\n        spec.solvent = Solvent.ORGANIC\n        score = self.adapter.estimate_fidelity(spec)\n        assert score.physics_fidelity < 0.2\n\n    def test_fidelity_bounded(self):\n        spec = make_beta_cd_guest_spec()\n        score = self.adapter.estimate_fidelity(spec)\n        assert 0.0 <= score.physics_fidelity <= 1.0\n\n    def test_advantages_populated(self):\n        spec = make_beta_cd_guest_spec()\n        score = self.adapter.estimate_fidelity(spec)\n        assert len(score.advantages) > 0\n\n\n# ─────────────────────────────────────────────\n# Test 4: Full Design Pipeline\n# ─────────────────────────────────────────────\n\nclass TestDesign:\n\n    def setup_method(self):\n        self.adapter = CyclodextrinAdapter()\n\n    def test_design_returns_cd_fab_spec(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert isinstance(fab, CyclodextrinFabSpec)\n\n    def test_design_selects_beta_for_155A3(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert fab.base_type == "beta"\n\n    def test_design_selects_alpha_for_100A3(self):\n        spec = make_alpha_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert fab.base_type == "alpha"\n\n    def test_design_selects_gamma_for_250A3(self):\n        spec = make_gamma_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert fab.base_type == "gamma"\n\n    def test_design_has_packing_coefficient(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert 0.3 < fab.packing_coefficient < 0.8\n\n    def test_design_has_synthesis_steps(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert len(fab.synthesis_steps) > 0\n\n    def test_design_has_validation_plan(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert len(fab.validation_experiments) >= 2\n        assert any("ITC" in v for v in fab.validation_experiments)\n\n    def test_design_has_supplier(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert len(fab.supplier) > 0\n\n    def test_design_predicts_binding(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert fab.predicted_dG_kJ_mol != 0.0\n        assert fab.predicted_logK != 0.0\n\n    def test_good_packing_negative_dG(self):\n        """Guest in Rebek sweet spot should have favorable (negative) ΔG."""\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert fab.predicted_dG_kJ_mol < 0\n\n\n# ─────────────────────────────────────────────\n# Test 5: Modification Logic\n# ─────────────────────────────────────────────\n\nclass TestModifications:\n\n    def setup_method(self):\n        self.adapter = CyclodextrinAdapter()\n\n    def test_beta_cd_gets_hp_modification(self):\n        """Native β-CD selected → should auto-recommend HP for solubility."""\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert "HP" in fab.modifications\n\n    def test_hp_rationale_mentions_solubility(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert any("solubility" in r.lower() for r in fab.modification_rationale)\n\n    def test_diagnostic_gets_click_handle(self):\n        spec = make_diagnostic_spec()\n        fab = self.adapter.design(spec)\n        assert fab.click_handle == "C6-azide"\n        assert "N3" in fab.modifications\n\n    def test_research_no_click_handle(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert fab.click_handle == "none"\n\n    def test_cationic_guest_gets_sbe(self):\n        spec = make_cationic_guest_spec()\n        fab = self.adapter.design(spec)\n        assert "SBE" in fab.modifications\n\n    def test_alpha_cd_no_hp(self):\n        """α-CD has good solubility natively — no HP needed."""\n        spec = make_alpha_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        assert "HP" not in fab.modifications\n\n\n# ─────────────────────────────────────────────\n# Test 6: Validation\n# ─────────────────────────────────────────────\n\nclass TestValidation:\n\n    def setup_method(self):\n        self.adapter = CyclodextrinAdapter()\n\n    def test_good_design_validates(self):\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        report = self.adapter.validate_design(fab)\n        assert report.valid\n\n    def test_extreme_pc_fails_validation(self):\n        """Manually set PC to extreme value → should flag issue."""\n        spec = make_beta_cd_guest_spec()\n        fab = self.adapter.design(spec)\n        fab.packing_coefficient = 0.95\n        report = self.adapter.validate_design(fab)\n        assert not report.valid\n        assert any("too high" in i for i in report.issues)\n\n    def test_wrong_type_fails(self):\n        from mabe.realization.models import FabricationSpec, CavityDimensions\n        wrong = FabricationSpec(\n            material_system="not_cd",\n            geometry_spec_hash="x",\n            predicted_pocket_geometry=CavityDimensions(0, 0, 0, 0),\n            predicted_deviation_from_ideal_A=0,\n        )\n        report = self.adapter.validate_design(wrong)\n        assert not report.valid\n',
}

def main():
    print("=== MABE Sprint R2a: Cyclodextrin Adapter ===")
    print()
    for filepath, content in FILES.items():
        dirpath = os.path.dirname(filepath)
        if dirpath:
            os.makedirs(dirpath, exist_ok=True)
        with open(filepath, "w", encoding="utf-8", newline="\n") as f:
            f.write(content)
        print(f"  Created {filepath}")
    print()
    print(f"=== Bootstrap complete: {len(FILES)} files ===")
    print()
    print("Run tests:")
    print("  python -m pytest mabe/realization/tests/test_sprint_r2a.py -v")
    print()
    print("Run all realization tests:")
    print("  python -m pytest mabe/realization/tests/ -v")

if __name__ == "__main__":
    main()